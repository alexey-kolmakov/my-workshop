#!/bin/bash
# === Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Wine-Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ°Ð¼Ð¸ ===
# ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚: winecfg, regedit, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ€Ð»Ñ‹ÐºÐ¾Ð²

# ÐŸÑƒÑ‚Ð¸
PREFIX_DIR="/home/minok/prefixes"
DESKTOP_DIR="$HOME/.local/share/applications"
BIN_DIR="$HOME/bin"

mkdir -p "$BIN_DIR" "$DESKTOP_DIR"

echo "=== Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Wine-Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ°Ð¼Ð¸ ==="

# 1ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸ Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ°Ð¼Ð¸
if [ ! -d "$PREFIX_DIR" ]; then
    echo "âŒ ÐŸÐ°Ð¿ÐºÐ° Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ°Ð¼Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: $PREFIX_DIR"
    exit 1
fi

# 2ï¸âƒ£ Ð’Ñ‹Ð±Ð¾Ñ€ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ°
echo
echo "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Wine-Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ:"
select PREFIX in "$PREFIX_DIR"/*; do
    if [ -n "$PREFIX" ]; then
        echo "âœ… Ð’Ñ‹Ð±Ñ€Ð°Ð½ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ: $PREFIX"
        break
    else
        echo "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
    fi
done

# 3ï¸âƒ£ Ð’Ñ‹Ð±Ð¾Ñ€ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
echo
echo "Ð§Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ñ ÑÑ‚Ð¸Ð¼ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼?"
select ACTION in "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ winecfg" "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ regedit" "Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÑ€Ð»Ñ‹Ðº Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹" "Ð’Ñ‹Ñ…Ð¾Ð´"; do
    case $ACTION in
        "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ winecfg")
            echo "Ð—Ð°Ð¿ÑƒÑÐº winecfg Ð´Ð»Ñ $PREFIX..."
            WINEPREFIX="$PREFIX" winecfg
            exit 0
            ;;
        "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ regedit")
            echo "Ð—Ð°Ð¿ÑƒÑÐº regedit Ð´Ð»Ñ $PREFIX..."
            WINEPREFIX="$PREFIX" wine regedit
            exit 0
            ;;
        "Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÑ€Ð»Ñ‹Ðº Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹")
            echo "â†’ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ðº ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ ÑÑ€Ð»Ñ‹ÐºÐ°..."
            break
            ;;
        "Ð’Ñ‹Ñ…Ð¾Ð´")
            echo "Ð’Ñ‹Ñ…Ð¾Ð´ Ð¸Ð· ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°."
            exit 0
            ;;
        *)
            echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°."
            ;;
    esac
done

# 4ï¸âƒ£ ÐŸÐ¾Ð¸ÑÐº exe-Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo
echo "Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐµÐ¼ .exe Ð²Ð½ÑƒÑ‚Ñ€Ð¸ \"$PREFIX/drive_c\" ..."
EXE_FILES=($(find "$PREFIX/drive_c" -maxdepth 6 -type f -iname "*.exe" \
    | grep -viE "unins|setup|update|autorun|install"))
EXE_FILES+=("Ð£ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ")

echo
echo "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑÑ€Ð»Ñ‹ÐºÐ°:"
select EXE in "${EXE_FILES[@]}"; do
    if [ -n "$EXE" ]; then
        if [ "$EXE" == "Ð£ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ" ]; then
            read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ðº .exe: " EXE
        fi
        echo "âœ… Ð’Ñ‹Ð±Ñ€Ð°Ð½ .exe: $EXE"
        break
    else
        echo "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
    fi
done

# 5ï¸âƒ£ Ð˜Ð¼Ñ ÑÑ€Ð»Ñ‹ÐºÐ° Ð¸ Ð¸ÐºÐ¾Ð½ÐºÐ°
echo
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ ÑÑ€Ð»Ñ‹ÐºÐ° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Total Commander): " NAME
read -p "Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸ÐºÐ¾Ð½ÐºÐ°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ðº Ð½ÐµÐ¹ (Ð¸Ð»Ð¸ Enter, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ): " ICON

# 6ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
SCRIPT_PATH="$BIN_DIR/${NAME// /_}.sh"
cat > "$SCRIPT_PATH" <<EOL
#!/bin/bash
env WINEPREFIX="$PREFIX" wine start /unix "$EXE"
EOL
chmod +x "$SCRIPT_PATH"
echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»: $SCRIPT_PATH"

# 7ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .desktop ÑÑ€Ð»Ñ‹Ðº
DESKTOP_FILE="$DESKTOP_DIR/${NAME// /_}.desktop"
cat > "$DESKTOP_FILE" <<EOL
[Desktop Entry]
Name=$NAME
Exec=$SCRIPT_PATH
Type=Application
Icon=$ICON
Categories=Utility;
Terminal=false
EOL
chmod +x "$DESKTOP_FILE"
echo "âœ… Ð¯Ñ€Ð»Ñ‹Ðº ÑÐ¾Ð·Ð´Ð°Ð½: $DESKTOP_FILE"

# 8ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð¸Ñ‚Ñ‹Ñ… ÑÑ€Ð»Ñ‹ÐºÐ¾Ð² (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
echo
echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ€Ð»Ñ‹ÐºÐ¾Ð² Ð½Ð° Ð±Ð¸Ñ‚Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ ==="
for file in "$DESKTOP_DIR"/*.desktop; do
    EXEC_LINE=$(grep '^Exec=' "$file")
    if [[ $EXEC_LINE =~ WINEPREFIX=([^[:space:]]+) ]]; then
        PREFIX_CHECK="${BASH_REMATCH[1]}"
        if [ ! -d "$PREFIX_CHECK" ]; then
            echo "âš ï¸  Ð‘Ð¸Ñ‚Ñ‹Ð¹ ÑÑ€Ð»Ñ‹Ðº: $file (Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ $PREFIX_CHECK Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½)"
        fi
    fi
done

echo
echo "ðŸŽ‰ Ð’ÑÑ‘ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾!"
