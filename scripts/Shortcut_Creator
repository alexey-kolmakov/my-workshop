#!/bin/bash

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–ø–∫—É —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞
get_desktop_dir() {
    local dir
    dir="$(xdg-user-dir DESKTOP)"
    if [ -z "$dir" ] || [ ! -d "$dir" ]; then
        dir="$HOME/Desktop"
        mkdir -p "$dir"
    fi
    echo "$dir"
}

# -------------------------------
# –ú–ï–ù–Æ –í–´–ë–û–†–ê –†–ï–ñ–ò–ú–ê
# -------------------------------
echo "üîπ –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å?"
echo "1) –Ø—Ä–ª—ã–∫ –¥–ª—è —Å–∞–π—Ç–∞"
echo "2) –Ø—Ä–ª—ã–∫ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä: " mode

# -------------------------------
# –†–ï–ñ–ò–ú 1 ‚Äî –Ø–†–õ–´–ö –î–õ–Ø –°–ê–ô–¢–ê
# -------------------------------
if [ "$mode" = "1" ]; then

    TARGET_DIR="$(get_desktop_dir)"

    echo "üîπ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —è—Ä–ª—ã–∫–∞:"
    read name

    echo "üîπ –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç:"
    read url

    # -----------------------------------------
# –ü–û–ò–°–ö –ë–†–ê–£–ó–ï–†–û–í + –ö–†–ê–°–ò–í–û–ï –ú–ï–ù–Æ ZENITY
# -----------------------------------------

# –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è —Ä–µ–¥–∫–∏–µ)
BROWSER_CANDIDATES=(
    firefox firefox-esr
    chromium chromium-browser
    google-chrome google-chrome-stable
    brave brave-browser
    vivaldi vivaldi-stable
    opera opera-stable opera-developer
    falkon midori slimjet tor-browser
)

FOUND_BROWSERS=()

# –ò—â–µ–º –±—Ä–∞—É–∑–µ—Ä—ã –≤ PATH
for b in "${BROWSER_CANDIDATES[@]}"; do
    if command -v "$b" >/dev/null 2>&1; then
        FOUND_BROWSERS+=("$b")
    fi
done

# –ò—â–µ–º –±—Ä–∞—É–∑–µ—Ä—ã –ø–æ .desktop —Ñ–∞–π–ª–∞–º (–∫–∞—Ç–µ–≥–æ—Ä–∏—è WebBrowser)
DESKTOP_BROWSERS=$(grep -ril "Categories=.*WebBrowser" \
    /usr/share/applications ~/.local/share/applications 2>/dev/null)

# –î–æ–±–∞–≤–ª—è–µ–º Exec –∏–∑ .desktop
while IFS= read -r file; do
    exec_line=$(grep -m1 "^Exec=" "$file" | sed 's/^Exec=//' | awk '{print $1}')
    [ -n "$exec_line" ] && FOUND_BROWSERS+=("$exec_line")
done <<< "$DESKTOP_BROWSERS"

# –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
FOUND_BROWSERS=($(printf "%s\n" "${FOUND_BROWSERS[@]}" | sort -u))

# –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –Ω–µ—Ç ‚Äî –æ—à–∏–±–∫–∞
if [ ${#FOUND_BROWSERS[@]} -eq 0 ]; then
    zenity --error --text="–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞!"
    exit 1
fi

# –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è zenity
ZENITY_LIST=()
for b in "${FOUND_BROWSERS[@]}"; do
    ZENITY_LIST+=("$b" "")
done

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –º–µ–Ω—é
browser=$(zenity --list \
    --modal \
    --title="–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä" \
    --column="–ë—Ä–∞—É–∑–µ—Ä" \
    --column="" \
    "${ZENITY_LIST[@]}")

# –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –æ—Ç–º–µ–Ω—É
if [ -z "$browser" ]; then
    zenity --error --text="–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω!"
    exit 1
fi


    # –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏
    echo "üîπ –í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É (PNG/SVG/JPG). –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å ‚Äî –±—É–¥–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è."
    icon_path=$(zenity --file-selection \
        --title="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É" \
        --file-filter="–ò–∫–æ–Ω–∫–∏ | *.png *.svg *.jpg *.jpeg" \
        --file-filter="–í—Å–µ —Ñ–∞–π–ª—ã | *")

    if [ -z "$icon_path" ]; then
        icon_path="web-browser"
    fi

    echo "üîπ –ö—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —è—Ä–ª—ã–∫? (Enter = $TARGET_DIR)"
    read custom_dir
    if [ -n "$custom_dir" ]; then
        TARGET_DIR="$custom_dir"
        mkdir -p "$TARGET_DIR"
    fi

    filename="$(echo "$name" | tr ' ' '_' ).desktop"
    if [ "$filename" = ".desktop" ]; then
        filename="shortcut_$(date +%s).desktop"
    fi

    cat <<EOF > "$TARGET_DIR/$filename"
[Desktop Entry]
Name=$name
Exec=$browser $url
Icon=$icon_path
Type=Application
Terminal=false
#Terminal=true
#Categories=Office;
#Categories=Education;
#Categories=TextEditor;Utility;
#Categories=Application;
EOF

    chmod +x "$TARGET_DIR/$filename"
    gio set "$TARGET_DIR/$filename" metadata::trusted true 2>/dev/null

    echo "‚úÖ –Ø—Ä–ª—ã–∫ —Å–æ–∑–¥–∞–Ω: $TARGET_DIR/$filename"
    exit 0
fi

# -------------------------------
# –†–ï–ñ–ò–ú 2 ‚Äî –Ø–†–õ–´–ö –î–õ–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# -------------------------------
if [ "$mode" = "2" ]; then

    TARGET_DIR="$(get_desktop_dir)"

    echo "üîπ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —è—Ä–ª—ã–∫–∞:"
    read name

    echo "üîπ –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å–∫—Ä–∏–ø—Ç, AppImage):"
    exec_path=$(zenity --file-selection \
        --title="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" \
        --file-filter="–ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ | *.sh *.py *.AppImage" \
        --file-filter="–í—Å–µ —Ñ–∞–π–ª—ã | *")

    if [ -z "$exec_path" ]; then
        echo "‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω."
        exit 1
    fi

    echo "üîπ –í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É (PNG/SVG/JPG). –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å ‚Äî –±—É–¥–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è."
    icon_path=$(zenity --file-selection \
        --title="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É" \
        --file-filter="–ò–∫–æ–Ω–∫–∏ | *.png *.svg *.jpg *.jpeg" \
        --file-filter="–í—Å–µ —Ñ–∞–π–ª—ã | *")

    if [ -z "$icon_path" ]; then
        icon_path="application-x-executable"
    fi

    echo "üîπ –ö—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —è—Ä–ª—ã–∫? (Enter = $TARGET_DIR)"
    read custom_dir
    if [ -n "$custom_dir" ]; then
        TARGET_DIR="$custom_dir"
        mkdir -p "$custom_dir"
    fi

    filename="$(echo "$name" | tr ' ' '_' ).desktop"
    if [ "$filename" = ".desktop" ]; then
        filename="app_$(date +%s).desktop"
    fi

    cat <<EOF > "$TARGET_DIR/$filename"
[Desktop Entry]
Name=$name
Exec="$exec_path"
Icon=$icon_path
Type=Application
Terminal=false
#Terminal=true
#Categories=Office;
#Categories=Education;
#Categories=TextEditor;Utility;
#Categories=Application;
EOF

    chmod +x "$TARGET_DIR/$filename"
    gio set "$TARGET_DIR/$filename" metadata::trusted true 2>/dev/null

    echo "‚úÖ –Ø—Ä–ª—ã–∫ —Å–æ–∑–¥–∞–Ω: $TARGET_DIR/$filename"
    exit 0
fi

echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º."
